<!DOCTYPE html>
<html lang="vi">
<head>
   <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V√¨ An To√†n C·ªßa Tr·∫ª Em</title>
    <!-- Add Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <!-- SweetAlert2 -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Toastify -->
    <link href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" rel="stylesheet">
    <!-- Add Chart.js for heart rate visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <link rel="stylesheet" href="/assest/css/style.css">
    <link rel="stylesheet" href="/assest/css/fa.all.min.css">
</head>
<style>
    .logo {
        margin-top: 7px;
        width: 50px; /* Adjust size as needed */
        height: 50px;
        margin-right: 10px; /* Space between logo and text */
        object-fit: contain; /* Ensure logo scales properly */
    }
</style>
<body>
    <div class="container">
        <header>
            <div class="search-actions"> 
                <img src="/assest/img/bg_app.png" alt="Logo" class="logo">
                <h1> H·ªá th·ªëng qu·∫£n l√Ω th√¥ng tin app SafeKid</h1>
            </div>
            <div class="search-actions">
                <button id="logout-btn" class="btn btn-secondary" style="background-color: rgb(247, 76, 76); color:#ffff; margin-right: 40px;">ƒêƒÉng xu·∫•t</button>
                <button id="create-user-btn" class="btn btn-primary">+ T·∫°o t√†i kho·∫£n</button>
            </div>
        </header>

        <div class="search-tabs">
            <div class="search-tab " data-tab="admin-management">Qu·∫£n l√≠ Admin</div>
            <div class="search-tab" data-tab="staff-management">Qu·∫£n l√≠ Nh√¢n vi√™n</div>
            <div class="search-tab active" data-tab="app-data">Th√¥ng tin d·ªØ li·ªáu</div>
        </div>

        <!-- Admin Management -->
        <div class="search-container hidden" id="admin-management">
            <div class="search-header">
                <div class="search-title">Danh s√°ch Qu·∫£n tr·ªã vi√™n</div>
                <div class="search-actions">
                    <button class="btn btn-secondary" id="refresh-admin">L√†m m·ªõi</button>
                    <button class="btn btn-primary" id="search-admin">T√¨m ki·∫øm</button>
                </div>
            </div>

            <div class="search-fields">
                <div class="form-group">
                    <label for="admin-name">T√™n qu·∫£n tr·ªã vi√™n</label>
                    <input type="text" id="admin-name" placeholder="Nh·∫≠p t√™n...">
                </div>

                <div class="form-group">
                    <label for="admin-email">Email</label>
                    <input type="text" id="admin-email" placeholder="Nh·∫≠p email...">
                </div>

                <div class="form-group">
                    <label for="admin-status">Tr·∫°ng th√°i</label>
                    <select id="admin-status">
                        <option value="">T·∫•t c·∫£</option>
                        <option value="active">Ho·∫°t ƒë·ªông</option>
                        <option value="inactive">Kh√¥ng ho·∫°t ƒë·ªông</option>
                    </select>
                </div>
            </div>

            <table class="results-table">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>H·ªç t√™n</th>
                        <th>Email</th>
                        <th>S·ªë ƒëi·ªán tho·∫°i</th>
                        <th>Ng√†y sinh</th>
                        <th>Gi·ªõi t√≠nh</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody id="admin-table-body">
                    <!-- Admin data will be loaded here -->
                </tbody>
            </table>

            <div class="pagination">
                <div class="page-item active">1</div>
                <div class="page-item">2</div>
                <div class="page-item">3</div>
                <div class="page-item">...</div>
                <div class="page-item">10</div>
            </div>
        </div>

        <!-- Staff Management -->
        <div class="search-container hidden" id="staff-management">
            <div class="search-header">
                <div class="search-title">Danh s√°ch Nh√¢n vi√™n</div>
                <div class="search-actions">
                    <button class="btn btn-secondary" id="refresh-staff">L√†m m·ªõi</button>
                    <button class="btn btn-primary" id="search-staff">T√¨m ki·∫øm</button>
                </div>
            </div>

            <div class="search-fields">
                <div class="form-group">
                    <label for="staff-name">T√™n nh√¢n vi√™n</label>
                    <input type="text" id="staff-name" placeholder="Nh·∫≠p t√™n...">
                </div>

                <div class="form-group">
                    <label for="staff-email">Email</label>
                    <input type="text" id="staff-email" placeholder="Nh·∫≠p email...">
                </div>

                <div class="form-group">
                    <label for="staff-status">Tr·∫°ng th√°i</label>
                    <select id="staff-status">
                        <option value="">T·∫•t c·∫£</option>
                        <option value="pending">Ch·ªù ph√™ duy·ªát</option>
                        <option value="active">ƒê√£ ph√™ duy·ªát</option>
                        <option value="inactive">Kh√¥ng ho·∫°t ƒë·ªông</option>
                    </select>
                </div>
            </div>

            <table class="results-table">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>H·ªç t√™n</th>
                        <th>Email</th>
                        <th>S·ªë ƒëi·ªán tho·∫°i</th>
                        <th>Ng√†y sinh</th>
                        <th>Gi·ªõi t√≠nh</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody id="staff-table-body">
                    <!-- Staff data will be loaded here -->
                </tbody>
            </table>

            <div class="pagination">
                <div class="page-item active">1</div>
                <div class="page-item">2</div>
                <div class="page-item">3</div>
                <div class="page-item">...</div>
                <div class="page-item">10</div>
            </div>
        </div>

        <!-- App Data -->
        <div class="search-container " id="app-data">
            <div class="search-header">
                <div class="search-title">Th√¥ng tin d·ªØ li·ªáu theo d√µi t·ª´ thi·∫øt b·ªã</div>
                <button id="reset-data-btn" class="btn" style="background-color: aqua;  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">Reset th√¥ng tin</button>
            </div>

            <div class="health-data">
                <div class="health-card">
                    <h3>Th√¥ng tin nh·ªãp tim</h3>
                    <div>
                        <p style="font-weight: 700;">Nh·ªãp tim hi·ªán t·∫°i: <span id="heart-rate" class="heart-rate-value">--</span> bpm</p>
                        <p style="font-weight: 700;">T√¨nh tr·∫°ng: <span style="font-weight: 600;" id="heart-status">Kh√¥ng c√≥ d·ªØ li·ªáu</span></p>
                        <canvas id="heart-rate-chart" height="200"></canvas>
                    </div>
                    
                </div>

                <div class="health-card">
                    <h3>Th√¥ng tin v·ªã tr√≠</h3>
                    <div>
                        <p  style="font-weight: 700;">Vƒ© ƒë·ªô: <span style="font-weight: 400;" id="latitude">--</span></p>
                        <p style="font-weight: 700;">Kinh ƒë·ªô: <span style="font-weight: 400;" id="longitude">--</span></p>
                        <p style="font-weight: 700;">Th·ªùi gian d·ª´ng l·∫°i: <span style="font-weight: 400;" id="location-time">--</span></p>
                        <p  style="font-weight: 700;">Tr·∫°ng th√°i qu√™n tr·∫ª: <span style="font-weight: 600;" id="forgot-status">--</span></p>
                        <p style="font-weight: 700;">ƒê·ªãa ch·ªâ: <span style="font-weight: 400;" id="address">ƒêang t·∫£i...</span></p>
                    </div>
                </div>
            </div>
            

            <div id="map-container">
                <h3>B·∫£n ƒë·ªì v·ªã tr√≠</h3>
                <div id="map"></div>
            </div>
        </div>
    </div>

    <!-- Create/Edit User Modal -->
    <div id="user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">T·∫°o t√†i kho·∫£n m·ªõi</h3>
                <span class="close-modal">&times;</span>
            </div>
            <form id="user-form">
                <input type="hidden" id="user-id">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="full-name">H·ªç v√† t√™n *</label>
                            <input type="text" id="full-name" required>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="email">Email *</label>
                            <input type="email" id="email" required>
                        </div>
                    </div>
                </div>

               <div class="form-row" id="password-fields">
                <div class="form-col">
                    <div class="form-group">
                        <label for="password">M·∫≠t kh·∫©u *</label>
                        <div class="password-wrapper">
                            <input type="password" id="password" required>
                            <span class="toggle-password" data-target="password">üëÅÔ∏è</span>
                        </div>
                    </div>
                </div>
                <div class="form-col">
                    <div class="form-group">
                        <label for="confirm-password">X√°c nh·∫≠n m·∫≠t kh·∫©u *</label>
                        <div class="password-wrapper">
                            <input type="password" id="confirm-password" required>
                            <span class="toggle-password" data-target="confirm-password">üëÅÔ∏è</span>
                        </div>
                    </div>
                </div>
            </div>

                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="phone">S·ªë ƒëi·ªán tho·∫°i</label>
                            <input type="tel" id="phone">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="birthdate">Ng√†y sinh</label>
                            <input type="date" id="birthdate">
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="gender">Gi·ªõi t√≠nh</label>
                            <select id="gender">
                                <option value="">Ch·ªçn gi·ªõi t√≠nh</option>
                                <option value="male">Nam</option>
                                <option value="female">N·ªØ</option>
                                <option value="other">Kh√°c</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="role">Vai tr√≤ *</label>
                            <select id="role" required>
                                <option value="">Ch·ªçn vai tr√≤</option>
                                <option value="admin">Qu·∫£n tr·ªã vi√™n</option>
                                <option value="staff">Nh√¢n vi√™n</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="address-input">ƒê·ªãa ch·ªâ</label>
                    <input type="text" id="address-input">
                </div>

                <div id="status-fields" class="form-row" style="display: none;">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="status">Tr·∫°ng th√°i</label>
                            <select id="status">
                                <option value="active">Ho·∫°t ƒë·ªông</option>
                                <option value="inactive">Kh√¥ng ho·∫°t ƒë·ªông</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="approved">Ph√™ duy·ªát</label>
                            <select id="approved">
                                <option value="true">ƒê√£ ph√™ duy·ªát</option>
                                <option value="false">Ch·ªù ph√™ duy·ªát</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="search-actions" style="justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary close-modal">H·ªßy</button>
                    <button type="submit" class="btn btn-primary" id="submit-btn">T·∫°o t√†i kho·∫£n</button>
                </div>
            </form>
        </div>
    </div>


    
    <script type="module">
        // Function to load Google Maps API dynamically
        function loadGoogleMapsAPI(callback) {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${import.meta.env.VITE_GOOGLE_MAPS_API_KEY}&libraries=visualization&callback=initMap`;
            script.async = true;
            script.defer = true;
            window.initMap = callback;
            document.head.appendChild(script);
        }

        // Ki·ªÉm tra ƒëƒÉng nh·∫≠p
        document.addEventListener('DOMContentLoaded', () => {
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));

            if (!currentUser) {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p');
                window.location.href = '/index.html';
            } else {
                alert(`Ch√†o m·ª´ng, ${currentUser.fullName}!`);
            }

            // Firebase configuration
            const firebaseConfig = {
                apiKey: import.meta.env.VITE_FIREBASE_API_KEY,
                authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN,
                databaseURL: import.meta.env.VITE_FIREBASE_DATABASE_URL,
                projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,
                storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET,
                messagingSenderId: import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID,
                appId: import.meta.env.VITE_FIREBASE_APP_ID,
                measurementId: import.meta.env.VITE_FIREBASE_MEASUREMENT_ID
            };

            // Initialize Firebase
            const app = firebase.initializeApp(firebaseConfig);
            const database = firebase.database();

            // DOM elements
            const tabs = document.querySelectorAll('.search-tab');
            const containers = document.querySelectorAll('.search-container');
            const logoutBtn = document.getElementById('logout-btn');
            const createUserBtn = document.getElementById('create-user-btn');
            const resetDataBtn = document.getElementById('reset-data-btn');
            const userModal = document.getElementById('user-modal');
            const closeModalBtns = document.querySelectorAll('.close-modal');
            const userForm = document.getElementById('user-form');
            const modalTitle = document.getElementById('modal-title');
            const submitBtn = document.getElementById('submit-btn');
            const passwordFields = document.getElementById('password-fields');
            const statusFields = document.getElementById('status-fields');
            const userIdField = document.getElementById('user-id');

            let heartRateChart = null;
            let map = null;
            let marker = null;

            // Tab switching functionality
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    containers.forEach(container => container.classList.add('hidden'));
                    const tabId = tab.getAttribute('data-tab');
                    document.getElementById(tabId).classList.remove('hidden');
                    if (tabId === 'admin-management') loadAdminUsers();
                    else if (tabId === 'staff-management') loadStaffUsers();
                    else if (tabId === 'app-data') loadAppData();
                });
            });

            // Modal functionality
            createUserBtn.addEventListener('click', () => {
                userForm.reset();
                modalTitle.textContent = 'T·∫°o t√†i kho·∫£n m·ªõi';
                submitBtn.textContent = 'T·∫°o t√†i kho·∫£n';
                passwordFields.style.display = 'flex';
                statusFields.style.display = 'none';
                userIdField.value = '';
                userModal.style.display = 'block';
            });

            closeModalBtns.forEach(btn => btn.addEventListener('click', () => userModal.style.display = 'none'));

            logoutBtn.addEventListener('click', () => {
                sessionStorage.removeItem('currentUser');
                window.location.href = '/index.html';
            });

            // Form submission for creating/updating user
            userForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const userId = userIdField.value;
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                const fullName = document.getElementById('full-name').value;
                const phone = document.getElementById('phone').value;
                const birthdate = document.getElementById('birthdate').value;
                const gender = document.getElementById('gender').value;
                const role = document.getElementById('role').value;
                const address = document.getElementById('address-input').value;
                const status = document.getElementById('status').value;
                const approved = document.getElementById('approved').value === 'true';

                if (password !== confirmPassword) {
                    alert('M·∫≠t kh·∫©u kh√¥ng kh·ªõp!');
                    return;
                }
                const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailPattern.test(email)) {
                    alert('Email kh√¥ng h·ª£p l·ªá!');
                    return;
                }

                try {
                    const snapshot = await database.ref('users').once('value');
                    const users = snapshot.val();
                    let emailExists = false;
                    if (users) {
                        Object.keys(users).forEach(key => {
                            if (users[key].email === email && key !== userId) emailExists = true;
                        });
                    }
                    if (emailExists) {
                        alert('T√†i kho·∫£n v·ªõi email n√†y ƒë√£ t·ªìn t·∫°i!');
                        return;
                    }

                    const userData = {
                        fullName, email, phone, birthdate, gender, role, address, status, approved, updatedAt: Date.now()
                    };
                    if (!role) {
                        alert('Vui l√≤ng ch·ªçn vai tr√≤ (role)!');
                        return;
                    }

                    if (userId) {
                        await database.ref('users/' + userId).update(userData);
                        userModal.style.display = 'none';
                        alert('C·∫≠p nh·∫≠t th√¥ng tin ng∆∞·ªùi d√πng th√†nh c√¥ng');
                    } else {
                        const newUserRef = database.ref('users').push();
                        userData.password = password;
                        userData.createdAt = Date.now();
                        userData.status = 'active';
                        userData.approved = role === 'admin';
                        await newUserRef.set(userData);
                        userModal.style.display = 'none';
                        alert('T·∫°o t√†i kho·∫£n th√†nh c√¥ng!');
                    }

                    const activeTab = document.querySelector('.search-tab.active').getAttribute('data-tab');
                    if (activeTab === 'admin-management') loadAdminUsers();
                    else if (activeTab === 'staff-management') loadStaffUsers();
                } catch (error) {
                    console.error('L·ªói khi l∆∞u user:', error);
                    alert('L·ªói: ' + error.message);
                }
            });

            // Toggle password visibility
            document.querySelectorAll('.toggle-password').forEach(button => {
                button.addEventListener('click', () => {
                    const targetId = button.getAttribute('data-target');
                    const input = document.getElementById(targetId);
                    const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                    input.setAttribute('type', type);
                    button.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üôà';
                });
            });

            // Reset data
            resetDataBtn.addEventListener('click', async () => {
                await database.ref('NhipTim').set(85);
                await database.ref('forgot_status').set(0);
                await database.ref('ToaDo').set({
                    lat: 16.077688,
                    long: 108.2139,
                    timestamp: Date.now()
                });
                alert('Reset th√¥ng tin th√†nh c√¥ng!');
            });

            // Load admin users
            async function loadAdminUsers() {
                const adminTableBody = document.getElementById('admin-table-body');
                adminTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';
                try {
                    const snapshot = await database.ref('users').orderByChild('role').equalTo('admin').once('value');
                    const users = snapshot.val();
                    adminTableBody.innerHTML = '';
                    if (!users) {
                        adminTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
                        return;
                    }
                    let count = 1;
                    Object.keys(users).forEach(userId => {
                        const user = users[userId];
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${count++}</td>
                            <td>${user.fullName || '--'}</td>
                            <td>${user.email}</td>
                            <td>${user.phone || '--'}</td>
                            <td>${user.birthdate ? new Date(user.birthdate).toLocaleDateString() : '--'}</td>
                            <td>${getGenderText(user.gender)}</td>
                            <td><span class="status ${user.status === 'active' ? 'status-active' : 'status-inactive'}">${user.status === 'active' ? 'Ho·∫°t ƒë·ªông' : 'Kh√¥ng ho·∫°t ƒë·ªông'}</span></td>
                            <td class="action-buttons">
                                <button class="btn btn-edit" data-id="${userId}">S·ª≠a</button>
                                <button class="btn ${user.status === 'active' ? 'btn-lock' : 'btn-approve'}" data-id="${userId}">${user.status === 'active' ? 'Kh√≥a' : 'M·ªü'}</button>
                                <button class="btn btn-delete" data-id="${userId}">X√≥a</button>
                            </td>
                        `;
                        adminTableBody.appendChild(row);
                    });
                    addUserActionListeners();
                } catch (error) {
                    console.error('Error loading admin users:', error);
                    adminTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">L·ªói khi t·∫£i d·ªØ li·ªáu</td></tr>';
                }
            }

            // Load staff users
            async function loadStaffUsers() {
                const staffTableBody = document.getElementById('staff-table-body');
                staffTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';
                try {
                    const snapshot = await database.ref('users').orderByChild('role').equalTo('staff').once('value');
                    const users = snapshot.val();
                    staffTableBody.innerHTML = '';
                    if (!users) {
                        staffTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
                        return;
                    }
                    let count = 1;
                    Object.keys(users).forEach(userId => {
                        const user = users[userId];
                        let statusClass = 'status-pending';
                        let statusText = 'Ch·ªù ph√™ duy·ªát';
                        if (user.approved) {
                            statusClass = user.status === 'active' ? 'status-active' : 'status-inactive';
                            statusText = user.status === 'active' ? 'Ho·∫°t ƒë·ªông' : 'Kh√¥ng ho·∫°t ƒë·ªông';
                        }
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${count++}</td>
                            <td>${user.fullName || '--'}</td>
                            <td>${user.email}</td>
                            <td>${user.phone || '--'}</td>
                            <td>${user.birthdate ? new Date(user.birthdate).toLocaleDateString() : '--'}</td>
                            <td>${getGenderText(user.gender)}</td>
                            <td><span class="status ${statusClass}">${statusText}</span></td>
                            <td class="action-buttons">
                                ${!user.approved ? `<button class="btn btn-approve" data-id="${userId}">Ph√™ duy·ªát</button>` : ''}
                                <button class="btn btn-edit" data-id="${userId}">S·ª≠a</button>
                                <button class="btn ${user.status === 'active' ? 'btn-lock' : 'btn-approve'}" data-id="${userId}">${user.status === 'active' ? 'Kh√≥a' : 'M·ªü'}</button>
                                <button class="btn btn-delete" data-id="${userId}">X√≥a</button>
                            </td>
                        `;
                        staffTableBody.appendChild(row);
                    });
                    addUserActionListeners();
                } catch (error) {
                    console.error('Error loading staff users:', error);
                    staffTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">L·ªói khi t·∫£i d·ªØ li·ªáu</td></tr>';
                }
            }

            // Add event listeners for user action buttons
            function addUserActionListeners() {
                document.querySelectorAll('.btn-edit').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const userId = e.target.getAttribute('data-id');
                        try {
                            const snapshot = await database.ref('users/' + userId).once('value');
                            const user = snapshot.val();
                            if (user) {
                                document.getElementById('full-name').value = user.fullName || '';
                                document.getElementById('email').value = user.email || '';
                                document.getElementById('phone').value = user.phone || '';
                                document.getElementById('birthdate').value = user.birthdate || '';
                                document.getElementById('gender').value = user.gender || '';
                                document.getElementById('role').value = user.role || '';
                                document.getElementById('address-input').value = user.address || '';
                                document.getElementById('status').value = user.status || 'active';
                                document.getElementById('approved').value = user.approved ? 'true' : 'false';
                                modalTitle.textContent = 'Ch·ªânh s·ª≠a t√†i kho·∫£n';
                                submitBtn.textContent = 'C·∫≠p nh·∫≠t';
                                passwordFields.style.display = 'none';
                                statusFields.style.display = 'flex';
                                userIdField.value = userId;
                                userModal.style.display = 'block';
                            }
                        } catch (error) {
                            console.error('Error loading user data:', error);
                            alert('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu ng∆∞·ªùi d√πng');
                        }
                    });
                });

                document.querySelectorAll('.btn-approve').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const userId = e.target.getAttribute('data-id');
                        if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ph√™ duy·ªát nh√¢n vi√™n n√†y?')) {
                            try {
                                await database.ref('users/' + userId).update({
                                    approved: true,
                                    status: 'active',
                                    updatedAt: Date.now()
                                });
                                alert('Ph√™ duy·ªát nh√¢n vi√™n th√†nh c√¥ng!');
                                const activeTab = document.querySelector('.search-tab.active').getAttribute('data-tab');
                                if (activeTab === 'admin-management') loadAdminUsers();
                                else if (activeTab === 'staff-management') loadStaffUsers();
                            } catch (error) {
                                console.error('Error approving staff:', error);
                                alert('Ph√™ duy·ªát kh√¥ng th√†nh c√¥ng: ' + error.message);
                            }
                        }
                    });
                });

                document.querySelectorAll('.btn-lock, .btn-approve:not(.btn-approve[data-id])').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        if (e.target.classList.contains('btn-approve') && e.target.textContent === 'Ph√™ duy·ªát') return;
                        const userId = e.target.getAttribute('data-id');
                        const currentStatus = e.target.classList.contains('btn-lock') ? 'active' : 'inactive';
                        const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
                        const action = currentStatus === 'active' ? 'kh√≥a' : 'm·ªü';
                        if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ${action} t√†i kho·∫£n n√†y?`)) {
                            try {
                                await database.ref('users/' + userId).update({
                                    status: newStatus,
                                    updatedAt: Date.now()
                                });
                                alert(`${action === 'kh√≥a' ? 'Kh√≥a' : 'M·ªü'} t√†i kho·∫£n th√†nh c√¥ng!`);
                                const activeTab = document.querySelector('.search-tab.active').getAttribute('data-tab');
                                if (activeTab === 'admin-management') loadAdminUsers();
                                else if (activeTab === 'staff-management') loadStaffUsers();
                            } catch (error) {
                                console.error(`Error ${action} user:`, error);
                                alert(`${action === 'kh√≥a' ? 'Kh√≥a' : 'M·ªü'} t√†i kho·∫£n kh√¥ng th√†nh c√¥ng: ${error.message}`);
                            }
                        }
                    });
                });

                document.querySelectorAll('.btn-delete').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const userId = e.target.getAttribute('data-id');
                        if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t√†i kho·∫£n n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.')) {
                            try {
                                await database.ref('users/' + userId).remove();
                                alert('X√≥a t√†i kho·∫£n th√†nh c√¥ng!');
                                const activeTab = document.querySelector('.search-tab.active').getAttribute('data-tab');
                                if (activeTab === 'admin-management') loadAdminUsers();
                                else if (activeTab === 'staff-management') loadStaffUsers();
                            } catch (error) {
                                console.error('Error deleting user:', error);
                                alert('X√≥a t√†i kho·∫£n kh√¥ng th√†nh c√¥ng: ' + error.message);
                            }
                        }
                    });
                });
            }

            function getGenderText(gender) {
                switch (gender) {
                    case 'male': return 'Nam';
                    case 'female': return 'N·ªØ';
                    case 'other': return 'Kh√°c';
                    default: return '--';
                }
            }

            // Load app data
            function loadAppData() {
                let lastAlertTime = 0;
                const ALERT_COOLDOWN = 30000;
                let lastLat = null;
                let lastLng = null;

                function calculateDistance(lat1, lng1, lat2, lng2) {
                    const R = 6371000;
                    const toRad = (degrees) => degrees * Math.PI / 180;
                    const dLat = toRad(lat2 - lat1);
                    const dLng = toRad(lng2 - lng1);
                    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                              Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                              Math.sin(dLng / 2) * Math.sin(dLng / 2);
                    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                    return R * c;
                }

                function initHeartRateChart() {
                    const ctx = document.getElementById('heart-rate-chart').getContext('2d');
                    heartRateChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Nh·ªãp tim (bpm)',
                                data: [],
                                borderColor: '#e74c3c',
                                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    suggestedMin: 50,
                                    suggestedMax: 120
                                }
                            }
                        }
                    });
                }

                function updateHeartRateChart(newRate) {
                    const labels = heartRateChart.data.labels;
                    const data = heartRateChart.data.datasets[0].data;
                    const now = new Date();
                    const timeString = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
                    labels.push(timeString);
                    data.push(newRate);
                    if (labels.length > 20) {
                        labels.shift();
                        data.shift();
                    }
                    heartRateChart.update();
                }

                function initMap(lat = 16.077688, lng = 108.2139) {
                    map = new google.maps.Map(document.getElementById('map'), {
                        center: { lat, lng },
                        zoom: 18,
                        mapTypeId: 'satellite'
                    });
                    marker = new google.maps.Marker({
                        position: { lat, lng },
                        map: map,
                        title: 'V·ªã tr√≠ hi·ªán t·∫°i'
                    });
                    const trafficLayer = new google.maps.TrafficLayer();
                    trafficLayer.setMap(map);
                }

                function updateMap(lat, lng) {
                    if (!map) {
                        initMap(lat, lng);
                        return;
                    }
                    const newPos = new google.maps.LatLng(lat, lng);
                    map.setCenter(newPos);
                    if (marker) marker.setPosition(newPos);
                    else {
                        marker = new google.maps.Marker({
                            position: newPos,
                            map: map,
                            title: 'V·ªã tr√≠ hi·ªán t·∫°i'
                        });
                    }
                }

                function getAddressFromLatLng(lat, lng) {
                    const apiKey = import.meta.env.VITE_OPENCAGE_API_KEY;
                    const url = `https://api.opencagedata.com/geocode/v1/json?q=${lat}+${lng}&key=${apiKey}`;
                    return fetch(url)
                        .then(response => response.json())
                        .then(data => {
                            if (data && data.results && data.results.length > 0) {
                                const address = data.results[0].formatted;
                                document.getElementById('address').textContent = address;
                                return address;
                            } else {
                                document.getElementById('address').textContent = 'Kh√¥ng t√¨m th·∫•y ƒë·ªãa ch·ªâ';
                                return 'Kh√¥ng t√¨m th·∫•y ƒë·ªãa ch·ªâ';
                            }
                        })
                        .catch(error => {
                            console.error('L·ªói khi g·ªçi API OpenCage:', error);
                            document.getElementById('address').textContent = 'L·ªói l·∫•y ƒë·ªãa ch·ªâ';
                            return 'L·ªói l·∫•y ƒë·ªãa ch·ªâ';
                        });
                }

                const updateLocation = debounce((locationData) => {
                    const lat = locationData.lat;
                    const lng = locationData.long;
                    if (lastLat !== null && lastLng !== null) {
                        const distance = calculateDistance(lastLat, lastLng, lat, lng);
                        if (distance < 10) {
                            console.log(`Kho·∫£ng c√°ch ${distance.toFixed(2)}m, b·ªè qua x·ª≠ l√Ω.`);
                            return;
                        }
                    }
                    lastLat = lat;
                    lastLng = lng;
                    const timestamp = locationData.timestamp;
                    const now = Date.now();
                    let diffMs = now - timestamp;
                    if (diffMs < 0 || diffMs > 1e15) diffMs = 0;
                    const diffSeconds = Math.floor(diffMs / 1000);
                    const diffMinutes = Math.floor(diffSeconds / 60);
                    const diffHours = Math.floor(diffMinutes / 60);
                    document.getElementById('latitude').textContent = lat;
                    document.getElementById('longitude').textContent = lng;
                    document.getElementById('location-time').textContent = `${diffHours} gi·ªù, ${diffMinutes % 60} ph√∫t, ${diffSeconds % 60} gi√¢y`;
                    getAddressFromLatLng(lat, lng).then(address => {
                        window.currentLocationData = { lat, lng, diffHours, diffMinutes, address };
                    });
                    updateMap(lat, lng);
                }, 1000);

                // Load data
                database.ref('NhipTim').on('value', (snapshot) => {
                    const heartRate = snapshot.val();
                    if (heartRate) {
                        document.getElementById('heart-rate').textContent = heartRate;
                        const heartStatus = document.getElementById('heart-status');
                        if (heartRate < 60) {
                            heartStatus.textContent = 'Nh·ªãp tim th·∫•p';
                            heartStatus.style.color = '#e67e22';
                            if (Date.now() - lastAlertTime > ALERT_COOLDOWN) {
                                showDangerAlert('C·∫£nh b√°o nh·ªãp tim th·∫•p', `Nh·ªãp tim: ${heartRate} bpm`);
                                lastAlertTime = Date.now();
                            }
                        } else if (heartRate > 100) {
                            heartStatus.textContent = 'Nh·ªãp tim cao';
                            heartStatus.style.color = '#e74c3c';
                            if (Date.now() - lastAlertTime > ALERT_COOLDOWN) {
                                showDangerAlert('C·∫£nh b√°o nh·ªãp tim cao', `Nh·ªãp tim: ${heartRate} bpm`);
                                lastAlertTime = Date.now();
                            }
                        } else {
                            heartStatus.textContent = 'B√¨nh th∆∞·ªùng';
                            heartStatus.style.color = '#2ecc71';
                        }
                        if (heartRateChart) updateHeartRateChart(heartRate);
                    }
                });

                database.ref('ToaDo').on('value', (snapshot) => {
                    const locationData = snapshot.val();
                    if (locationData) updateLocation(locationData);
                });

                database.ref('forgot_status').on('value', (snapshot) => {
                    const forgotStatus = snapshot.val();
                    const forgotStatusElement = document.getElementById('forgot-status');
                    if (forgotStatus === 1) {
                        forgotStatusElement.textContent = 'Ph√°t hi·ªán b·ªè qu√™n tr·∫ª tr√™n xe';
                        forgotStatusElement.style.color = '#e74c3c';
                        if (Date.now() - lastAlertTime > ALERT_COOLDOWN) {
                            const checkAddress = () => {
                                const { address = 'V·ªã tr√≠ kh√¥ng kh·∫£ d·ª•ng', diffHours = 0, diffMinutes = 0 } = window.currentLocationData || {};
                                if (address && address !== 'V·ªã tr√≠ kh√¥ng kh·∫£ d·ª•ng') {
                                    showEmergencyAlert('KH·∫®N C·∫§P: TR·∫∫ B·ªä B·ªé QU√äN', `V·ªã tr√≠: ${address}, Th·ªùi gian d·ª´ng: ${diffHours} gi·ªù ${diffMinutes % 60} ph√∫t`);
                                    lastAlertTime = Date.now();
                                } else setTimeout(checkAddress, 1000);
                            };
                            checkAddress();
                        }
                    } else {
                        forgotStatusElement.textContent = 'B√¨nh th∆∞·ªùng - H·ªá th·ªëng an to√†n';
                        forgotStatusElement.style.color = '#2ecc71';
                    }
                });

                initHeartRateChart();
                loadGoogleMapsAPI(() => {
                    initMap(16.077688, 108.2139); // Default location
                });
            }

            function debounce(func, wait) {
                let timeout;
                return function (...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            }

            function showDangerAlert(title, message) {
                Toastify({
                    text: `${title}: ${message}`,
                    duration: 10000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)",
                    stopOnFocus: true
                }).showToast();
                Swal.fire({
                    icon: 'warning',
                    title: title,
                    text: message,
                    confirmButtonText: 'ƒê√£ hi·ªÉu',
                    confirmButtonColor: '#3085d6'
                });
            }

            function showEmergencyAlert(title, message) {
                Toastify({
                    text: `üö® ${title}: ${message}`,
                    duration: 10000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "linear-gradient(to right, #ff416c, #ff4b2b)",
                    stopOnFocus: true
                }).showToast();
                Swal.fire({
                    icon: 'error',
                    title: title,
                    html: `<div style="color:red">${message}</div>`,
                    confirmButtonText: 'X√°c nh·∫≠n',
                    confirmButtonColor: '#d33'
                });
            }

            // Refresh buttons
            document.getElementById('refresh-admin').addEventListener('click', loadAdminUsers);
            document.getElementById('refresh-staff').addEventListener('click', loadStaffUsers);

            // Search buttons
            document.getElementById('search-admin').addEventListener('click', async () => {
                const adminTableBody = document.getElementById('admin-table-body');
                adminTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">ƒêang t√¨m ki·∫øm...</td></tr>';
                const nameKeyword = document.getElementById('admin-name').value.toLowerCase().trim();
                const emailKeyword = document.getElementById('admin-email').value.toLowerCase().trim();
                const statusFilter = document.getElementById('admin-status').value;
                try {
                    const snapshot = await database.ref('users').orderByChild('role').equalTo('admin').once('value');
                    const users = snapshot.val();
                    adminTableBody.innerHTML = '';
                    if (!users) {
                        adminTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
                        return;
                    }
                    let count = 1;
                    let hasResults = false;
                    Object.keys(users).forEach(userId => {
                        const user = users[userId];
                        const matchesName = nameKeyword ? user.fullName?.toLowerCase().includes(nameKeyword) : true;
                        const matchesEmail = emailKeyword ? user.email?.toLowerCase().includes(emailKeyword) : true;
                        const matchesStatus = statusFilter ? user.status === statusFilter : true;
                        if (matchesName && matchesEmail && matchesStatus) {
                            hasResults = true;
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${count++}</td>
                                <td>${user.fullName || '--'}</td>
                                <td>${user.email}</td>
                                <td>${user.phone || '--'}</td>
                                <td>${user.birthdate ? new Date(user.birthdate).toLocaleDateString() : '--'}</td>
                                <td>${getGenderText(user.gender)}</td>
                                <td><span class="status ${user.status === 'active' ? 'status-active' : 'status-inactive'}">${user.status === 'active' ? 'Ho·∫°t ƒë·ªông' : 'Kh√¥ng ho·∫°t ƒë·ªông'}</span></td>
                                <td class="action-buttons">
                                    <button class="btn btn-edit" data-id="${userId}">S·ª≠a</button>
                                    <button class="btn ${user.status === 'active' ? 'btn-lock' : 'btn-approve'}" data-id="${userId}">${user.status === 'active' ? 'Kh√≥a' : 'M·ªü'}</button>
                                    <button class="btn btn-delete" data-id="${userId}">X√≥a</button>
                                </td>
                            `;
                            adminTableBody.appendChild(row);
                        }
                    });
                    if (!hasResults) {
                        adminTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</td></tr>';
                    }
                    addUserActionListeners();
                } catch (error) {
                    console.error('L·ªói khi t√¨m ki·∫øm admin:', error);
                    adminTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">L·ªói khi t√¨m ki·∫øm d·ªØ li·ªáu</td></tr>';
                }
            });

            document.getElementById('search-staff').addEventListener('click', async () => {
                const staffTableBody = document.getElementById('staff-table-body');
                staffTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">ƒêang t√¨m ki·∫øm...</td></tr>';
                const nameKeyword = document.getElementById('staff-name').value.toLowerCase().trim();
                const emailKeyword = document.getElementById('staff-email').value.toLowerCase().trim();
                const statusFilter = document.getElementById('staff-status').value;
                try {
                    const snapshot = await database.ref('users').orderByChild('role').equalTo('staff').once('value');
                    const users = snapshot.val();
                    staffTableBody.innerHTML = '';
                    if (!users) {
                        staffTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
                        return;
                    }
                    let count = 1;
                    let hasResults = false;
                    Object.keys(users).forEach(userId => {
                        const user = users[userId];
                        const matchesName = nameKeyword ? user.fullName?.toLowerCase().includes(nameKeyword) : true;
                        const matchesEmail = emailKeyword ? user.email?.toLowerCase().includes(emailKeyword) : true;
                        let matchesStatus = true;
                        if (statusFilter) {
                            if (statusFilter === 'pending') matchesStatus = !user.approved;
                            else if (statusFilter === 'active') matchesStatus = user.approved && user.status === 'active';
                            else if (statusFilter === 'inactive') matchesStatus = user.approved && user.status === 'inactive';
                        }
                        if (matchesName && matchesEmail && matchesStatus) {
                            hasResults = true;
                            let statusClass = 'status-pending';
                            let statusText = 'Ch·ªù ph√™ duy·ªát';
                            if (user.approved) {
                                statusClass = user.status === 'active' ? 'status-active' : 'status-inactive';
                                statusText = user.status === 'active' ? 'Ho·∫°t ƒë·ªông' : 'Kh√¥ng ho·∫°t ƒë·ªông';
                            }
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${count++}</td>
                                <td>${user.fullName || '--'}</td>
                                <td>${user.email}</td>
                                <td>${user.phone || '--'}</td>
                                <td>${user.birthdate ? new Date(user.birthdate).toLocaleDateString() : '--'}</td>
                                <td>${getGenderText(user.gender)}</td>
                                <td><span class="status ${statusClass}">${statusText}</span></td>
                                <td class="action-buttons">
                                    ${!user.approved ? `<button class="btn btn-approve" data-id="${userId}">Ph√™ duy·ªát</button>` : ''}
                                    <button class="btn btn-edit" data-id="${userId}">S·ª≠a</button>
                                    <button class="btn ${user.status === 'active' ? 'btn-lock' : 'btn-approve'}" data-id="${userId}">${user.status === 'active' ? 'Kh√≥a' : 'M·ªü'}</button>
                                    <button class="btn btn-delete" data-id="${userId}">X√≥a</button>
                                </td>
                            `;
                            staffTableBody.appendChild(row);
                        }
                    });
                    if (!hasResults) {
                        staffTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</td></tr>';
                    }
                    addUserActionListeners();
                } catch (error) {
                    console.error('L·ªói khi t√¨m ki·∫øm nh√¢n vi√™n:', error);
                    staffTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">L·ªói khi t√¨m ki·∫øm d·ªØ li·ªáu</td></tr>';
                }
            });
            loadAppData();
        });
    </script>
  
</html>